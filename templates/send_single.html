{% extends "base.html" %}

{% block title %}Send Single SMS - SMS Application{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-paper-plane me-2"></i>Send Single SMS
        </h1>
        <p class="text-muted">Send an SMS message to a single recipient.</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <form id="singleSmsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">
                                    <i class="fas fa-phone me-1"></i>Phone Number
                                </label>
                                <input type="tel" class="form-control" id="phoneNumber" 
                                       placeholder="+1234567890" required>
                                <div class="form-text">
                                    Include country code (e.g., +1 for US, +254 for Kenya)
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="senderId" class="form-label">
                                    <i class="fas fa-user me-1"></i>Sender ID (Optional)
                                </label>
                                <input type="text" class="form-control" id="senderId" 
                                       placeholder="Your Name or Number">
                                <div class="form-text">
                                    Leave blank to use default sender ID
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="message" class="form-label">
                            <i class="fas fa-comment me-1"></i>Message
                        </label>
                        <textarea class="form-control" id="message" rows="4" 
                                  placeholder="Type your SMS message here..." required maxlength="1600"></textarea>
                        <div class="form-text d-flex justify-content-between">
                            <span>SMS messages longer than 160 characters may be split into multiple parts</span>
                            <span id="charCount">0/1600 characters</span>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary me-md-2" onclick="clearForm()">
                            <i class="fas fa-eraser me-1"></i>Clear
                        </button>
                        <button type="submit" class="btn btn-primary" id="sendBtn">
                            <i class="fas fa-paper-plane me-1"></i>Send SMS
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultsModalTitle">
                    <i class="fas fa-info-circle me-2"></i>SMS Sending Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultsModalBody">
                <!-- Results will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="location.href='{{ url_for('reports') }}'">
                    <i class="fas fa-chart-bar me-1"></i>View Reports
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Character counter
document.getElementById('message').addEventListener('input', function() {
    const charCount = this.value.length;
    document.getElementById('charCount').textContent = `${charCount}/1600 characters`;
    
    if (charCount > 160) {
        document.getElementById('charCount').classList.add('text-warning');
    } else {
        document.getElementById('charCount').classList.remove('text-warning');
    }
});

// Form submission
document.getElementById('singleSmsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const phoneNumber = document.getElementById('phoneNumber').value.trim();
    const message = document.getElementById('message').value.trim();
    const senderId = document.getElementById('senderId').value.trim();
    const sendBtn = document.getElementById('sendBtn');
    
    if (!phoneNumber || !message) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Show loading state
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
    
    try {
        const response = await fetch('/api/send-sms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                phone_numbers: [phoneNumber],
                message: message,
                sender: senderId || null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showResults(result);
        } else {
            throw new Error(result.error || 'Unknown error occurred');
        }
        
    } catch (error) {
        alert(`Error: ${error.message}`);
    } finally {
        // Reset button
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send SMS';
    }
});

function showResults(result) {
    const modalBody = document.getElementById('resultsModalBody');
    const modalTitle = document.getElementById('resultsModalTitle');
    
    if (result.successful > 0) {
        modalTitle.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>SMS Sent Successfully!';
        modalTitle.className = 'modal-title text-success';
    } else {
        modalTitle.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i>SMS Sending Failed';
        modalTitle.className = 'modal-title text-danger';
    }
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <h5 class="text-success"><i class="fas fa-check-circle"></i> ${result.successful}</h5>
                        <p class="mb-0">Successful</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <h5 class="text-danger"><i class="fas fa-times-circle"></i> ${result.failed}</h5>
                        <p class="mb-0">Failed</p>
                    </div>
                </div>
            </div>
        </div>
        
        <hr>
        
        <div class="row">
            <div class="col-12">
                <h6>Details:</h6>
                <ul class="list-unstyled">
                    <li><strong>Total Messages:</strong> ${result.total_sent}</li>
                    <li><strong>Duration:</strong> ${result.duration} seconds</li>
                    ${result.bulk_id ? `<li><strong>Bulk ID:</strong> <code>${result.bulk_id}</code></li>` : ''}
                </ul>
            </div>
        </div>
    `;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('resultsModal')).show();
}

function clearForm() {
    document.getElementById('singleSmsForm').reset();
    document.getElementById('charCount').textContent = '0/1600 characters';
    document.getElementById('charCount').classList.remove('text-warning');
}
</script>
{% endblock %}

